---
title: "Untitled"
author: "Rodrigo"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r, cache=FALSE, message=FALSE, warning=FALSE, results='hide'}

if (!require("pacman")) install.packages("pacman")

pacotes_cran <- c(
  "devtools",
  "tidyverse",    # Coleção de pacotes para manipulação e visualização de dados (ggplot2, dplyr, etc.)
  "vcfR",         # Para ler e manipular arquivos VCF (seus dados genéticos)
  "CMplot",       # Para criar gráficos de Manhattan e outros gráficos genômicos
  "parallel",     # Para executar tarefas em paralelo e acelerar o processamento
  "ggpubr",       # Facilita a criação de gráficos prontos para publicação
  "ggh4x",        # Extensões para o ggplot2
  "grid",          # Funções gráficas de baixo nível
  "circlize",
  "onemap"
)
# formato "nome_do_usuario/nome_do_repositorio".
pacotes_github <- c(
  "dcgerard/segtest@higher", # Pacote para testes de segregação. A parte "@higher" instala uma versão específica.
  "dcgerard/updog",          # Para genotipagem de poliploides
  "dcgerard/ldsep",          # Para análise de desequilíbrio de ligação
  "jendelman/GWASpoly",      # Para estudos de associação genômica ampla (GWAS) em poliploides
  "mmollina/mappoly"         # Para construção de mapas de ligação em poliploides
)

pacman::p_load(char = pacotes_cran)
pacman::p_load_gh(char = pacotes_github)

rm(list = ls())
gc(verbose = FALSE)
```

```{r, cache=FALSE}


library(vcfR)
library(ape)

# Ler o seu arquivo de anotação GFF.
gff <- ape::read.gff("F:/Dados_projeto/analise_danubia/genomic.gff")
cat("Dimensões do arquivo GFF original:", dim(gff), "\n") 


dna <- read.dna("F:/Dados_projeto/analise_danubia/GCF_036785885.1_Coffea_Arabica_ET-39_HiFi_genomic.fna", format = "fasta")


vcf_Cc <- read.vcfR("F:/Dados_projeto/analise_danubia/Ca_var_norm_filter_BIAL_QUAL_AF_NS_flex.vcf")


chrom <- create.chromR(name = 'NC_092310.1', vcf = vcf_Cc, seq = dna, ann = gff) 
png(filename = "grafico_controle_qualidade_Cc.png", width = 1000, height = 800)
chromoqc(chrom, dp.alpha = 20)
dev.off()


plot(chrom)


chromoqc(chrom, dp.alpha = 20) 
```
```{r, cache=FALSE}
# ler arquivos vcf

vcf_Ca <- read.vcfR("F:/Dados_projeto/analise_danubia/Ca_var_norm_filter_BIAL_QUAL_AF_NS_flex.vcf", verbose = TRUE)
vcf_Cc <- read.vcfR("F:/Dados_projeto/analise_danubia/Cc_var_norm_filter_BIAL_QUAL_AF_NS_flex.vcf", verbose = TRUE)
vcf_Ce <- read.vcfR("F:/Dados_projeto/analise_danubia/Ce_var_norm_filter_BIAL_QUAL_AF_NS_flex.vcf", verbose = TRUE)

#extrair contagem de reads do alelo alternativo
AOmat_Ca <- extract.gt(vcf_Ca, element = "AO", as.numeric = TRUE)
AOmat_Cc <- extract.gt(vcf_Cc, element = "AO", as.numeric = TRUE)
AOmat_Ce <- extract.gt(vcf_Ce, element = "AO", as.numeric = TRUE)

#extraindo profundidade

DPmat_Ca <- extract.gt(vcf_Ca, element = "DP", as.numeric = TRUE)
DPmat_Cc <- extract.gt(vcf_Cc, element = "DP", as.numeric = TRUE)
DPmat_Ce <- extract.gt(vcf_Ce, element = "DP", as.numeric = TRUE)

#Verificação
AOmat_Ca[1:10,1:5]

rm(vcf_Ca, vcf_Ce, vcf_Cc); gc(verbose = FALSE)
```
```{r, cache=FALSE}
counts_Ca <- table(matrix(unlist(strsplit(rownames(AOmat_Ca), split = "_")), ncol = 2, byrow = TRUE)[,1])
counts_Cc <- table(matrix(unlist(strsplit(rownames(AOmat_Cc), split = "_")), ncol = 2, byrow = TRUE)[,1])
counts_Ce <- table(matrix(unlist(strsplit(rownames(AOmat_Ce), split = "_")), ncol = 2, byrow = TRUE)[,1])

#converte em dataframe
counts_Ca <- data.frame(Reference=rep("Ca", lenght(counts_Ca)), counts_Ca)
counts_Ce <- data.frame(Reference=rep("Ce", lenght(counts_Ce)), counts_Ce)
counts_Ca <- data.frame(Reference=rep("Cc", lenght(counts_Cc)), counts_Cc)

# juntar os data frames

counts2x <- rbind(counts_Ca, counts_Ce, counts_Cc)
